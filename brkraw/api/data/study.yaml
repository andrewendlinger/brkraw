name: tonifti-studyinfo
type: recipe
subtype: studyinfo
version: 24.5.14

study:
  startup: 
    - import numpy as np
    - from xnippet.formatter import DateTimeFormatter as dtf
    - from brkraw.api import StudyData
  ParaVision: 
    first_avail:
      - header.sw_version
      - version_string: study_ref.VisuCreatorVersion
        script: StudyData.parse_version(str(version_string))
  StudyDate:
    date_code:
      date:
        first_avail:
          - header.study_date
          - header.date
          - study_ref.VisuCreationDate
      script: np.squeeze(date).tolist() if isinstance(date, list) else date
    script: dtf(date_code).get()
  UserAccount: 
    first_avail:
      - header.study_operator
      - header.referral
      - study_ref.VisuStudyReferringPhysician
  Researcher:
    first_avail:
      - header.name_string
      - study_ref.VisuSubjectName
  SubjectID: 
    first_avail:
      - header.id
      - study_ref.VisuSubjectId
  SessionID: 
    first_avail:
      - header.study_name
      - study_ref.VisuStudyId
  TrialID: 
    first_avail:
      - header.study_nr
      - study_ref.VisuStudyNumber
  DateOfBirth: 
    first_avail:
      - header.dbirth
      - study_ref.VisuSubjectBirthDate
  Type: 
    first_avail:
      - header.type
      - study_ref.VisuSubjectType
  Sex:
    first_avail:
      - header.gender
      - header.sex
      - study_ref.VisuSubjectSex
  Weight:
    first_avail:
      - header.study_weight
      - header.weight
      - study_ref.VisuSubjectWeight
  Position:
    first_avail:
      - header.study_instrument_position
      - entry: header.entry
        position: header.position
        script: entry.replace("First", "").split("_").pop(-1) + "_" + position.split("_").pop(-1)
      - study_ref.VisuSubjectPosition

scan:
  Protocol: protocol.protocol_name
  Sequence: 
    first_avail:
      - protocol.scan_method
      - ppg: protocol.pulse_program
        script: ppg.split('.')[0]
  TR: seqparams.repetition_time
  TE: seqparams.echo_time
  FlipAngle: seqparams.flip_angle
  EffBW: seqparams.effbw

reco:
  dim: image.dim
  MatrixSize: image.shape
  NumSlicePack: slicepack.num_slice_packs
  NumSlices: slicepack.num_slices_each_pack
  NumCycles: cycle.num_cycles
  Resolution: image.resolution
  SliceDistances: slicepack.slice_distances_each_pack
  TemporalResol: cycle.time_step
  SliceOrderScheme: slicepack.slice_order_scheme
  dimDescription:
    dim_desc: image.dim_desc
    fg_desc: frame_group.id
    script: dim_desc + [f.split("_")[-1].lower() for f in fg_desc]
  ImageType: frame_group.type
